{% extends "base.html" %}

{% block title %}{{ lesson.title }} - EnglishMaster{% endblock %}

{% block content %}
<div class="lesson-detail-page">
    <div class="container">
        <div class="breadcrumb">
            <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
            <span>‚Üí</span>
            <a href="{{ url_for('main.lessons_page') }}">Lec»õii</a>
            <span>‚Üí</span>
            <span class="current">{{ lesson.title }}</span>
        </div>

        <div class="lesson-header">
            <div class="lesson-header-left">
                <span class="lesson-level-badge level-{{ lesson.level }}">
                    {{ lesson.get_level_display() }}
                </span>
                <h1>{{ lesson.title }}</h1>
                <p class="lesson-description-full">{{ lesson.description }}</p>
                
                <div class="lesson-meta-full">
                    <div class="meta-item-full">
                        <span class="meta-icon">üë®‚Äçüè´</span>
                        <div>
                            <strong>{{ lesson.professor.get_full_name() }}</strong>
                            <small>{{ lesson.professor.specialization }}</small>
                        </div>
                    </div>
                    <div class="meta-item-full">
                        <span class="meta-icon">‚è±Ô∏è</span>
                        <div>
                            <strong>{{ lesson.duration_minutes }} minute</strong>
                            <small>DuratƒÉ estimatƒÉ</small>
                        </div>
                    </div>
                    <div class="meta-item-full">
                        <span class="meta-icon">üìä</span>
                        <div>
                            <strong>{{ lesson.get_difficulty_stars() }}</strong>
                            <small>Dificultate</small>
                        </div>
                    </div>
                    {% if lesson.category %}
                    <div class="meta-item-full">
                        <span class="meta-icon">üìÅ</span>
                        <div>
                            <strong>{{ lesson.category }}</strong>
                            <small>Categorie</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="lesson-header-right">
                <div class="lesson-stats-card">
                    <h3>Statistici</h3>
                    <div class="stat-row">
                        <span>üëÅÔ∏è VizualizƒÉri:</span>
                        <strong>{{ lesson.views }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>‚úÖ FinalizƒÉri:</span>
                        <strong>{{ lesson.completions }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>üìà RatƒÉ finalizare:</span>
                        <strong>{{ lesson.calculate_completion_rate() }}%</strong>
                    </div>
                    {% if lesson.rating > 0 %}
                    <div class="stat-row">
                        <span>‚≠ê Rating:</span>
                        <strong>{{ "%.1f"|format(lesson.rating) }}/5.0</strong>
                    </div>
                    <div class="stat-row">
                        <span>üí¨ Recenzii:</span>
                        <strong>{{ lesson.total_ratings }}</strong>
                    </div>
                    {% else %}
                    <div class="stat-row">
                        <span>‚≠ê Rating:</span>
                        <strong>FƒÉrƒÉ rating</strong>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="lesson-content-section">
            <div class="lesson-main-content">
                <div class="content-card">
                    <h2>üìñ Con»õinutul Lec»õiei</h2>
                    <div class="lesson-content-text">
                        {{ lesson.content|safe }}
                    </div>
                </div>

                <div class="lesson-actions">
                    {% if quiz %}
                        {% if submissions %}
                            {% set best_submission = submissions|sort(attribute='score', reverse=True)|first %}
                            <div class="quiz-status">
                                {% if best_submission.passed %}
                                    <span class="status-icon">‚úÖ</span>
                                    <div>
                                        <strong>Ai promovat!</strong>
                                        <small>Cel mai bun scor: {{ best_submission.score|int }}%</small>
                                    </div>
                                {% else %}
                                    <span class="status-icon">üìù</span>
                                    <div>
                                        <strong>√éncearcƒÉ din nou</strong>
                                        <small>√éncercƒÉri: {{ submissions|length }} / {{ quiz.max_attempts }}</small>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        {% if not submissions or (submissions|length < quiz.max_attempts and not submissions|selectattr('passed')|list) %}
                            <a href="{{ url_for('main.quiz_page', quiz_id=quiz.id) }}" class="btn btn-success btn-large">
                                {% if submissions %}
                                    üîÑ Re√ÆncearcƒÉ Quiz-ul
                                {% else %}
                                    ‚úÖ √éncepe Quiz-ul ({{ quiz.points_reward }} puncte)
                                {% endif %}
                            </a>
                        {% endif %}
                        
                        {% if submissions %}
                            <a href="{{ url_for('main.quiz_results', quiz_id=quiz.id, submission_id=submissions[0].id) }}" class="btn btn-secondary">
                                üìä Vezi Ultimul Rezultat
                            </a>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            ‚ÑπÔ∏è Quiz-ul pentru aceastƒÉ lec»õie va fi disponibil √Æn cur√¢nd!
                        </div>
                    {% endif %}
                    
                    <button class="btn btn-secondary" onclick="saveLesson()">
                        üîñ SalveazƒÉ lec»õia
                    </button>
                    <a href="{{ url_for('main.lessons_page') }}" class="btn btn-outline">
                        ‚Üê √énapoi la lec»õii
                    </a>
                </div>
            </div>

            <div class="lesson-sidebar">
                <div class="sidebar-card">
                    <h3>‚ÑπÔ∏è Informa»õii</h3>
                    <div class="info-list">
                        <div class="info-item">
                            <strong>Publicat:</strong>
                            <span>{{ lesson.created_at.strftime('%d %B %Y') }}</span>
                        </div>
                        <div class="info-item">
                            <strong>Actualizat:</strong>
                            <span>{{ lesson.updated_at.strftime('%d %B %Y') }}</span>
                        </div>
                        <div class="info-item">
                            <strong>Status:</strong>
                            <span class="status-badge">{{ lesson.status }}</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>üìö Lec»õii similare</h3>
                    <div class="text-muted">√én cur√¢nd...</div>
                </div>

                <div class="sidebar-card sticky-progress">
                    <h3>üéØ Progresul tƒÉu</h3>
                    <div class="progress-info">
                        <p id="progress-message">Cite»ôti aceastƒÉ lec»õie...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <small id="progress-text">0.0% completat</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.lesson-detail-page {
    padding: 40px 0;
}

.breadcrumb {
    margin-bottom: 30px;
    font-size: 14px;
    color: var(--text-light);
}

.breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.breadcrumb .current {
    color: var(--text-dark);
    font-weight: 600;
}

/* Header */
.lesson-header {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
}

.lesson-header-left {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: var(--shadow);
}

.lesson-level-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 15px;
}

.lesson-level-badge.level-beginner {
    background: #D4EDDA;
    color: #155724;
}

.lesson-level-badge.level-intermediate {
    background: #FFF3CD;
    color: #856404;
}

.lesson-level-badge.level-advanced {
    background: #F8D7DA;
    color: #721C24;
}

.lesson-header h1 {
    font-size: 32px;
    margin-bottom: 15px;
    line-height: 1.3;
}

.lesson-description-full {
    font-size: 16px;
    color: var(--text-light);
    line-height: 1.6;
    margin-bottom: 25px;
}

.lesson-meta-full {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
}

.meta-item-full {
    display: flex;
    align-items: center;
    gap: 12px;
}

.meta-icon {
    font-size: 28px;
}

.meta-item-full div {
    display: flex;
    flex-direction: column;
}

.meta-item-full strong {
    font-size: 14px;
    color: var(--text-dark);
}

.meta-item-full small {
    font-size: 12px;
    color: var(--text-light);
}

/* Stats Card */
.lesson-header-right {
    display: flex;
    flex-direction: column;
}

.lesson-stats-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: var(--shadow);
}

.lesson-stats-card h3 {
    margin-bottom: 20px;
    font-size: 18px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-row span {
    color: var(--text-light);
}

.stat-row strong {
    color: var(--text-dark);
}

/* Content Section */
.lesson-content-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
}

.lesson-main-content {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.content-card {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: var(--shadow);
}

.content-card h2 {
    font-size: 24px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--primary-color);
}

.lesson-content-text {
    font-size: 16px;
    line-height: 1.8;
    color: var(--text-dark);
}

.lesson-content-text p {
    margin-bottom: 15px;
}

.lesson-content-text h3 {
    font-size: 20px;
    margin: 25px 0 15px 0;
    color: var(--primary-color);
}

.lesson-content-text ul, .lesson-content-text ol {
    margin: 15px 0;
    padding-left: 25px;
}

.lesson-content-text li {
    margin-bottom: 10px;
}

/* Actions */
.lesson-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.quiz-status {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px 20px;
    background: var(--bg-light);
    border-radius: 8px;
    flex: 1;
}

.status-icon {
    font-size: 32px;
}

.quiz-status div strong {
    display: block;
    color: var(--text-dark);
    margin-bottom: 3px;
}

.quiz-status div small {
    display: block;
    color: var(--text-light);
    font-size: 13px;
}

.alert {
    padding: 15px 20px;
    border-radius: 8px;
    flex: 1;
}

.alert-info {
    background: #E3F2FD;
    color: #1976D2;
}

.btn-large {
    padding: 15px 30px;
    font-size: 16px;
}

.btn-outline {
    background: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* Sidebar */
.lesson-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sidebar-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
}

.sidebar-card h3 {
    font-size: 16px;
    margin-bottom: 15px;
}

/* STICKY BOTTOM 
   Folosim un truc cu 'top' pentru a o »õine jos √Æn viewport.
   100vh (√ÆnƒÉl»õime ecran) - 180px (aproximativ √ÆnƒÉl»õimea cardului + padding).
*/
.sticky-progress {
    position: -webkit-sticky;
    position: sticky;
    top: calc(100vh - 180px); 
    z-index: 10;
    transition: box-shadow 0.3s ease;
}

.sticky-progress.scrolled {
    box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.15); /* UmbrƒÉ √Æn sus */
}

.progress-info {
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: var(--bg-light);
    border-radius: 5px;
    overflow: hidden;
    margin: 15px 0 10px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    transition: width 0.2s ease-out;
}

.info-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
}

.info-item strong {
    color: var(--text-dark);
}

.info-item span {
    color: var(--text-light);
}

.status-badge {
    padding: 4px 12px;
    background: #D4EDDA;
    color: #155724;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.text-muted {
    color: var(--text-light);
    font-size: 14px;
}

/* Responsive */
@media (max-width: 968px) {
    .lesson-header,
    .lesson-content-section {
        grid-template-columns: 1fr;
    }
    
    .lesson-meta-full {
        grid-template-columns: 1fr 1fr;
    }

    .sticky-progress {
        position: static;
    }
}

@media (max-width: 600px) {
    .lesson-meta-full {
        grid-template-columns: 1fr;
    }
    
    .lesson-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function saveLesson() {
    alert('Lec»õie salvatƒÉ! Vei gƒÉsi lec»õiile salvate √Æn profilul tƒÉu.');
    // TODO: Implementare salvare lec»õii
}

// LogicƒÉ completƒÉ pentru Progres Bar
window.addEventListener('scroll', function() {
    // 1. CalculƒÉm progresul
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    
    let scrolled = 0;
    if (height > 0) {
        scrolled = (winScroll / height) * 100;
    } else {
        scrolled = 100;
    }

    if (scrolled > 100) scrolled = 100;
    if (scrolled < 0) scrolled = 0;
    
    // 2. Elementele DOM
    const progressBar = document.querySelector('.progress-fill');
    const progressText = document.getElementById('progress-text');
    const progressMessage = document.getElementById('progress-message');
    const stickyCard = document.querySelector('.sticky-progress');
    
    // 3. Update UI
    if (progressBar) {
        progressBar.style.width = scrolled + '%';
    }
    
    if (progressText) {
        // Floating point (o zecimalƒÉ)
        progressText.textContent = scrolled.toFixed(1) + '% completat';
    }

    if (progressMessage) {
        if (scrolled >= 99) {
            progressMessage.textContent = "üéâ Lec»õie parcursƒÉ!";
            progressMessage.style.fontWeight = "bold";
            progressMessage.style.color = "var(--primary-color)";
        } else {
            progressMessage.textContent = "Cite»ôti aceastƒÉ lec»õie...";
            progressMessage.style.fontWeight = "normal";
            progressMessage.style.color = "inherit";
        }
    }

    // UmbrƒÉ pentru sticky bottom
    if (stickyCard) {
        if (winScroll > 100) {
            stickyCard.classList.add('scrolled');
        } else {
            stickyCard.classList.remove('scrolled');
        }
    }
});

window.dispatchEvent(new Event('scroll'));
</script>
{% endblock %}
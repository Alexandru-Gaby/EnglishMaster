{% extends "base.html" %}

{% block title %}Panou Profesor - EnglishMaster{% endblock %}

{% block content %}
<div class="professor-dashboard">
    <div class="container">
        <h1>üìä Panou Profesor</h1>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchProfTab('classes')">üë• Clasele Mele</button>
            <button class="tab-btn" onclick="switchProfTab('questions')">‚ùì BƒÉnci √éntrebƒÉri</button>
            <button class="tab-btn" onclick="switchProfTab('feedback')">üí¨ Feedback</button>
        </div>

        <!-- CLASE TAB -->
        <div id="classes-tab" class="tab-content active">
            <div class="section">
                <h2>Clasele Mele</h2>
                <button class="btn btn-primary" onclick="showCreateClassModal()">+ Creare ClasƒÉ NouƒÉ</button>
                
                <div id="classesList" class="classes-grid">
                    <div class="loading">Se √ÆncarcƒÉ...</div>
                </div>
            </div>
        </div>

        <!-- INTREBARI TAB -->
        <div id="questions-tab" class="tab-content">
            <div class="section">
                <h2>BƒÉnci de √éntrebƒÉri</h2>
                <button class="btn btn-primary" onclick="showCreateBankModal()">+ BancƒÉ NouƒÉ</button>
                
                <div id="banksList" class="banks-grid">
                    <div class="loading">Se √ÆncarcƒÉ...</div>
                </div>
            </div>
        </div>

        <!-- FEEDBACK TAB -->
        <div id="feedback-tab" class="tab-content">
            <div class="section">
                <h2>Feedback Trimis</h2>
                <button class="btn btn-primary" onclick="showSendFeedbackModal()">+ Trimite Feedback</button>
                
                <div id="feedbackList" class="feedback-list">
                    <div class="loading">Se √ÆncarcƒÉ...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->

<!-- Create Class Modal -->
<div id="createClassModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('createClassModal')">&times;</span>
        <h3>Creare ClasƒÉ NouƒÉ</h3>
        
        <form onsubmit="createClass(event)">
            <div class="form-group">
                <label>Nume ClasƒÉ:</label>
                <input type="text" id="className" required>
            </div>
            
            <div class="form-group">
                <label>Descriere:</label>
                <textarea id="classDescription"></textarea>
            </div>
            
            <button type="submit" class="btn btn-success">Creare</button>
        </form>
    </div>
</div>

<!-- Create Bank Modal -->
<div id="createBankModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('createBankModal')">&times;</span>
        <h3>BancƒÉ NouƒÉ de √éntrebƒÉri</h3>
        
        <form onsubmit="createQuestionBank(event)">
            <div class="form-group">
                <label>Nume BancƒÉ:</label>
                <input type="text" id="bankName" required>
            </div>
            
            <div class="form-group">
                <label>Descriere:</label>
                <textarea id="bankDescription"></textarea>
            </div>
            
            <div class="form-group">
                <label>Categorie:</label>
                <input type="text" id="bankCategory">
            </div>
            
            <button type="submit" class="btn btn-success">Creare</button>
        </form>
    </div>
</div>

<!-- Send Feedback Modal -->
<div id="sendFeedbackModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('sendFeedbackModal')">&times;</span>
        <h3>Trimite Feedback</h3>
        
        <form onsubmit="sendFeedback(event)">
            <div class="form-group">
                <label>Student:</label>
                <input type="text" id="feedbackStudentEmail" placeholder="Email student" required>
            </div>
            
            <div class="form-group">
                <label>Titlu:</label>
                <input type="text" id="feedbackTitle" required>
            </div>
            
            <div class="form-group">
                <label>Con»õinut:</label>
                <textarea id="feedbackContent" required></textarea>
            </div>
            
            <div class="form-group">
                <label>Rating (1-5):</label>
                <select id="feedbackRating">
                    <option value="">FƒÉrƒÉ rating</option>
                    <option value="1">‚≠ê</option>
                    <option value="2">‚≠ê‚≠ê</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-success">Trimite</button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.professor-dashboard {
    padding: 30px 0;
    background: var(--bg-light);
    min-height: calc(100vh - 150px);
}

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 2px solid var(--border-color);
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: var(--text-light);
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: var(--shadow);
}

.section h2 {
    margin-bottom: 20px;
}

.classes-grid, .banks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.class-card, .bank-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.3s;
}

.class-card:hover, .bank-card:hover {
    transform: translateY(-5px);
}

.class-card h3, .bank-card h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
}

.class-card .code {
    background: rgba(255,255,255,0.2);
    padding: 8px 12px;
    border-radius: 6px;
    font-family: monospace;
    margin: 10px 0;
    font-size: 14px;
}

.class-card .info, .bank-card .info {
    font-size: 14px;
    margin-top: 10px;
    opacity: 0.9;
}

.feedback-list {
    margin-top: 20px;
}

.feedback-item {
    background: white;
    border-left: 4px solid var(--primary-color);
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 6px;
    box-shadow: var(--shadow);
}

.feedback-item.unread {
    background: #f0f8ff;
    border-left-color: #2196F3;
}

.feedback-item h4 {
    margin: 0 0 8px 0;
}

.feedback-item .meta {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 10px;
}

.feedback-item .content {
    margin: 10px 0;
    line-height: 1.5;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.close {
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.close:hover {
    color: #000;
}

.modal-content h3 {
    margin-top: 0;
    color: var(--primary-color);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-dark);
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: var(--text-light);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    opacity: 0.9;
}

.btn-success {
    background: #2ecc71;
    color: white;
    width: 100%;
}

.btn-success:hover {
    background: #27ae60;
}

@media (max-width: 768px) {
    .classes-grid, .banks-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        margin: 50% auto;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function switchProfTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'classes') loadClasses();
    if (tabName === 'questions') loadQuestionBanks();
    if (tabName === 'feedback') loadFeedback();
}

function showCreateClassModal() {
    document.getElementById('createClassModal').style.display = 'block';
}

function showCreateBankModal() {
    document.getElementById('createBankModal').style.display = 'block';
}

function showSendFeedbackModal() {
    document.getElementById('sendFeedbackModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

window.onclick = function(e) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(m => {
        if (e.target === m) m.style.display = 'none';
    });
}

function createClass(event) {
    event.preventDefault();
    const data = {
        name: document.getElementById('className').value,
        description: document.getElementById('classDescription').value
    };
    
    fetch('/api/classes/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('ClasƒÉ creatƒÉ! Cod: ' + data.class.code);
            closeModal('createClassModal');
            loadClasses();
        } else {
            alert('Eroare: ' + data.error);
        }
    });
}

function createQuestionBank(event) {
    event.preventDefault();
    const data = {
        name: document.getElementById('bankName').value,
        description: document.getElementById('bankDescription').value,
        category: document.getElementById('bankCategory').value
    };
    
    fetch('/api/question-banks/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('BancƒÉ creatƒÉ!');
            closeModal('createBankModal');
            loadQuestionBanks();
        } else {
            alert('Eroare: ' + data.error);
        }
    });
}

function sendFeedback(event) {
    event.preventDefault();
    const email = document.getElementById('feedbackStudentEmail').value;
    
    fetch('/api/user/current').then(r => r.json()).then(userData => {
        const data = {
            student_id: userData.user.id,
            title: document.getElementById('feedbackTitle').value,
            content: document.getElementById('feedbackContent').value,
            rating: document.getElementById('feedbackRating').value || null
        };
        
        fetch('/api/feedback/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Feedback trimis!');
                closeModal('sendFeedbackModal');
                loadFeedback();
            } else {
                alert('Eroare: ' + data.error);
            }
        });
    });
}

function loadClasses() {
    fetch('/api/classes')
    .then(r => r.json())
    .then(data => {
        const container = document.getElementById('classesList');
        if (!data.classes || data.classes.length === 0) {
            container.innerHTML = '<p>Nicio clasƒÉ creatƒÉ. CreazƒÉ una!</p>';
            return;
        }
        
        let html = '';
        data.classes.forEach(cls => {
            html += `
            <div class="class-card" onclick="viewClass(${cls.id})">
                <h3>${cls.name}</h3>
                <div class="code">Cod: ${cls.code}</div>
                <div class="info">üë• ${cls.student_count} studen»õi</div>
                <div class="info">üìÖ ${new Date(cls.created_at).toLocaleDateString('ro-RO')}</div>
            </div>
            `;
        });
        container.innerHTML = html;
    });
}

function loadQuestionBanks() {
    fetch('/api/question-banks')
    .then(r => r.json())
    .then(data => {
        const container = document.getElementById('banksList');
        if (!data.banks || data.banks.length === 0) {
            container.innerHTML = '<p>Nicio bancƒÉ creatƒÉ.</p>';
            return;
        }
        
        let html = '';
        data.banks.forEach(bank => {
            html += `
            <div class="bank-card" onclick="viewBank(${bank.id})">
                <h3>${bank.name}</h3>
                <p>${bank.description || 'FƒÉrƒÉ descriere'}</p>
                <div class="info">‚ùì ${bank.question_count} √ÆntrebƒÉri</div>
                ${bank.category ? '<div class="info">üè∑Ô∏è ' + bank.category + '</div>' : ''}
            </div>
            `;
        });
        container.innerHTML = html;
    });
}

function loadFeedback() {
    fetch('/api/feedback')
    .then(r => r.json())
    .then(data => {
        const container = document.getElementById('feedbackList');
        if (!data.feedbacks || data.feedbacks.length === 0) {
            container.innerHTML = '<p>Niciun feedback trimis.</p>';
            return;
        }
        
        let html = '';
        data.feedbacks.forEach(fb => {
            html += `
            <div class="feedback-item">
                <h4>${fb.title}</h4>
                <div class="meta">Pentru: <strong>${fb.student_name}</strong> | ${new Date(fb.created_at).toLocaleDateString('ro-RO')}</div>
                <div class="content">${fb.content}</div>
                ${fb.rating ? '<div class="meta">Rating: ' + '‚≠ê'.repeat(fb.rating) + '</div>' : ''}
            </div>
            `;
        });
        container.innerHTML = html;
    });
}

function viewClass(classId) {
    window.location.href = `/class/${classId}`;
}

function viewBank(bankId) {
    window.location.href = `/question-banks/${bankId}`;
}

// Load on init
document.addEventListener('DOMContentLoaded', function() {
    loadClasses();
});
</script>
{% endblock %}

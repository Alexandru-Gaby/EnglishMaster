{% extends "base.html" %}

{% block title %}Dashboard - EnglishMaster{% endblock %}

{% block content %}
<div class="dashboard-page">
    <div class="container">
        <div class="dashboard-header">
            <h1>Bun venit, {{ current_user.first_name }}! üëã</h1>
            <p class="role-badge role-{{ current_user.role }}">{{ current_user.role|upper }}</p>
        </div>

        <!-- Statistici -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-icon">‚≠ê</span>
                <div>
                    <div id="totalPoints" class="stat-number">{{ current_user.points }}</div>
                    <div class="stat-label">Puncte Totale</div>
                </div>
            </div>
            
            {% if current_user.role == 'professor' %}
            <div class="stat-card">
                <span class="stat-icon">‚≠ê</span>
                <div>
                    <div class="stat-number">{{ '%.1f'|format(current_user.rating) }}</div>
                    <div class="stat-label">Rating</div>
                </div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">üë•</span>
                <div>
                    <div class="stat-number">{{ meetings|length }}</div>
                    <div class="stat-label">√ént√¢lniri</div>
                </div>
            </div>
            {% else %}
            <!-- Statistici pentru studen»õi -->
            <div class="stat-card">
                <span class="stat-icon">üìö</span>
                <div>
                    <div class="stat-number" id="completedLessons">0</div>
                    <div class="stat-label">Lec»õii Finalizate</div>
                </div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">üèÜ</span>
                <div>
                    <div class="stat-number" id="totalBadges">0</div>
                    <div class="stat-label">Badge-uri</div>
                </div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">üî•</span>
                <div>
                    <div class="stat-number" id="streakDays">0</div>
                    <div class="stat-label">Zile Consecutive</div>
                </div>
            </div>
            {% endif %}
        </div>

        {% if current_user.role == 'user' %}
        <!-- Progres Section (doar pentru studen»õi) -->
        <div class="progress-section">
            <h2>üìà Progresul TƒÉu</h2>
            
            <div class="progress-overview">
                <div class="progress-details">
                    <div class="progress-item">
                        <span class="progress-emoji">üìö</span>
                        <strong>Lec»õii √Æn progres:</strong>
                        <span id="inProgressLessons" class="progress-value">0</span>
                    </div>
                    <div class="progress-item">
                        <span class="progress-emoji">üìù</span>
                        <strong>Quiz-uri sus»õinute:</strong>
                        <span id="totalQuizzes" class="progress-value">0</span>
                    </div>
                    <div class="progress-item">
                        <span class="progress-emoji">üéØ</span>
                        <strong>Scor mediu:</strong>
                        <span id="averageScore" class="progress-value">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <h2>üìã Activitate RecentƒÉ</h2>
            <div id="recentActivity" class="activity-list">
                <p class="text-muted">Se √ÆncarcƒÉ...</p>
            </div>
        </div>

        <!-- Badges Section -->
        <div class="badges-section">
            <div class="section-header">
                <h2>üèÜ Badge-urile Tale</h2>
            </div>
            <div id="badgesContainer" class="badges-container">
                <p class="text-muted">Se √ÆncarcƒÉ...</p>
            </div>
        </div>
        {% endif %}

        <!-- Ac»õiuni rapide -->
        <div class="quick-actions">
            <h2>Ac»õiuni Rapide</h2>
            <div class="actions-grid">
                {% if current_user.role == 'user' %}
                    <a href="{{ url_for('main.lessons_page') }}" class="action-card">
                        <span class="action-icon">üìñ</span>
                        <h3>Lec»õii</h3>
                        <p>ContinuƒÉ √ÆnvƒÉ»õarea</p>
                    </a>
                    <a href="{{ url_for('main.professors_page') }}" class="action-card action-highlight">
                        <span class="action-icon">üë®‚Äçüè´</span>
                        <h3>ProgrameazƒÉ Feedback</h3>
                        <p>
                            {% if current_user.can_request_feedback() %}
                                Ai {{ current_user.points }} puncte!
                            {% else %}
                                NecesitƒÉ 500 puncte
                            {% endif %}
                        </p>
                    </a>
                    <a href="{{ url_for('main.meetings_page') }}" class="action-card">
                        <span class="action-icon">üìÖ</span>
                        <h3>√ént√¢lnirile Mele</h3>
                        <p>Vezi programul</p>
                    </a>
                    <a href="#" class="action-card">
                        <span class="action-icon">üìä</span>
                        <h3>Clasament</h3>
                        <p>Vezi pozi»õia ta</p>
                    </a>
                {% else %}
                    <a href="{{ url_for('main.meetings_page') }}" class="action-card action-highlight">
                        <span class="action-icon">üìÖ</span>
                        <h3>Cereri de √ént√¢lniri</h3>
                        <p>GestioneazƒÉ programul</p>
                    </a>
                    <a href="{{ url_for('main.my_lessons') }}" class="action-card">
                        <span class="action-icon">üìù</span>
                        <h3>Lec»õiile Mele</h3>
                        <p>CreeazƒÉ con»õinut</p>
                    </a>
                    <a href="#" class="action-card">
                        <span class="action-icon">üë•</span>
                        <h3>Clasele Mele</h3>
                        <p>MonitorizeazƒÉ studen»õi</p>
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- √ént√¢lniri recente -->
        {% if meetings %}
        <div class="recent-meetings">
            <div class="section-header">
                <h2>√ént√¢lniri Recente</h2>
                <a href="{{ url_for('main.meetings_page') }}" class="link-button">Vezi toate ‚Üí</a>
            </div>
            <div class="meetings-list">
                {% for meeting in meetings[:3] %}
                <div class="meeting-card status-{{ meeting.status }}">
                    <div class="meeting-header">
                        <div>
                            {% if current_user.role == 'professor' %}
                                <h3>{{ meeting.student.get_full_name() }}</h3>
                                <p class="meeting-email">{{ meeting.student.email }}</p>
                            {% else %}
                                <h3>{{ meeting.professor.get_full_name() }}</h3>
                                <p class="meeting-spec">{{ meeting.professor.specialization }}</p>
                            {% endif %}
                        </div>
                        <span class="status-badge status-{{ meeting.status }}">
                            {{ meeting.status|upper }}
                        </span>
                    </div>
                    <div class="meeting-details">
                        <p><strong>üìÖ Data:</strong> {{ meeting.meeting_date.strftime('%d.%m.%Y %H:%M') }}</p>
                        <p><strong>‚è±Ô∏è DuratƒÉ:</strong> {{ meeting.duration_minutes }} minute</p>
                        {% if meeting.student_message %}
                        <p><strong>üí¨ Mesaj:</strong> {{ meeting.student_message }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.dashboard-page {
    padding: 40px 0;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.role-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
}

.role-user { background: #E3F2FD; color: #1976D2; }
.role-professor { background: #F3E5F5; color: #7B1FA2; }
.role-admin { background: #FFEBEE; color: #C62828; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.quick-actions h2, .recent-meetings h2 {
    margin-bottom: 20px;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.action-card {
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-decoration: none;
    color: inherit;
    box-shadow: var(--shadow);
    transition: all 0.3s;
    text-align: center;
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.action-highlight {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.action-icon {
    font-size: 48px;
    display: block;
    margin-bottom: 15px;
}

.action-card h3 {
    margin-bottom: 10px;
    font-size: 18px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.link-button {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 600;
}

.meetings-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.meeting-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    border-left: 4px solid #ccc;
}

.meeting-card.status-pending { border-left-color: #F39C12; }
.meeting-card.status-confirmed { border-left-color: #2ECC71; }
.meeting-card.status-rejected { border-left-color: #E74C3C; }
.meeting-card.status-completed { border-left-color: #3498DB; }

.meeting-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 15px;
}

.meeting-email, .meeting-spec {
    color: var(--text-light);
    font-size: 14px;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
}

.status-badge.status-pending { background: #FFF3CD; color: #856404; }
.status-badge.status-confirmed { background: #D4EDDA; color: #155724; }
.status-badge.status-rejected { background: #F8D7DA; color: #721C24; }
.status-badge.status-completed { background: #D1ECF1; color: #0C5460; }

/* Progress Circle - Reduced Size */
.progress-circle {
    width: 180px !important;
    height: 180px !important;
    margin: 0 auto;
}

.progress-circle svg {
    width: 100%;
    height: 100%;
}

.progress-text {
    font-size: 16px;
}

.progress-number {
    font-size: 28px !important;
    font-weight: 700;
}

/* Progress Details Gamification */
.progress-details {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-left: 30px;
}

.progress-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.progress-item:hover {
    transform: translateX(8px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.progress-emoji {
    font-size: 24px;
    min-width: 28px;
    text-align: center;
    animation: bounce 2s infinite;
}

.progress-value {
    font-weight: 700;
    font-size: 18px;
    color: #667eea;
    margin-left: auto;
    background: white;
    padding: 4px 12px;
    border-radius: 6px;
    min-width: 50px;
    text-align: center;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
}

@media (max-width: 768px) {
    .progress-overview {
        flex-direction: column;
    }
    
    .progress-details {
        margin-left: 0;
        margin-top: 20px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
async function loadDashboard() {
    try {
        const res = await fetch('/api/progress');
        const data = await res.json();
        if (!data.success) return;

        const stats = data.stats || {};

        // Update top-level stats
        const totalPointsEl = document.getElementById('totalPoints');
        if (totalPointsEl) totalPointsEl.textContent = stats.total_points;

        const completedLessonsEl = document.getElementById('completedLessons');
        if (completedLessonsEl) completedLessonsEl.textContent = stats.completed_lessons;

        const totalBadgesEl = document.getElementById('totalBadges');
        if (totalBadgesEl) totalBadgesEl.textContent = stats.total_badges;

        const streakEl = document.getElementById('streakDays');
        if (streakEl) streakEl.textContent = (stats.consecutive_days || 0);

        const completionRateEl = document.getElementById('completionRate');
        if (completionRateEl) completionRateEl.textContent = (stats.completion_rate || 0) + '%';

        const inProgEl = document.getElementById('inProgressLessons');
        if (inProgEl) inProgEl.textContent = stats.in_progress_lessons;

        const totalQuizzesEl = document.getElementById('totalQuizzes');
        if (totalQuizzesEl) totalQuizzesEl.textContent = (data.recent_quizzes || []).length;

        // Average score: compute from recent_quizzes if available
        const avgEl = document.getElementById('averageScore');
        if (avgEl) {
            const recent = data.recent_quizzes || [];
            if (recent.length > 0) {
                const sum = recent.reduce((s, q) => s + (q.score || 0), 0);
                const avg = Math.round((sum / recent.length) * 10) / 10; // one decimal
                avgEl.textContent = avg + '%';
            } else {
                avgEl.textContent = '0%';
            }
        }

        // Recent activity
        const recentContainer = document.getElementById('recentActivity');
        if (recentContainer) {
            recentContainer.innerHTML = '';
            const recent = data.recent_quizzes || [];
            if (recent.length === 0) {
                recentContainer.innerHTML = '<p class="text-muted">Nicio activitate recentƒÉ.</p>';
            } else {
                recent.forEach(s => {
                    const d = new Date(s.submitted_at);
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    const lessonLabel = s.lesson_title ? s.lesson_title : ('#' + s.lesson_id);
                    item.innerHTML = `
                        <div class="activity-row">
                            <div><strong>${s.quiz_id ? 'Quiz' : ''}</strong> la lec»õia ${lessonLabel}</div>
                            <div><strong>${s.score}%</strong></div>
                        </div>
                       <div class="activity-meta">${d.toLocaleString('ro-RO', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit' 
                    })}</div>

                    `;
                    recentContainer.appendChild(item);
                });
            }
        }

        // Badges
        const badgesContainer = document.getElementById('badgesContainer');
        if (badgesContainer) {
            badgesContainer.innerHTML = '';
            const badges = data.badges || [];
            if (badges.length === 0) {
                badgesContainer.innerHTML = '<p class="text-muted">Nu ai √ÆncƒÉ badge-uri.</p>';
            } else {
                const grid = document.createElement('div');
                grid.className = 'badges-grid';
                badges.forEach(b => {
                    const card = document.createElement('div');
                    card.className = 'badge-card';
                    card.innerHTML = `
                        <div class="badge-icon">${b.icon || 'üèÜ'}</div>
                        <div class="badge-info">
                            <div class="badge-name">${b.name}</div>
                            <div class="badge-desc">${b.description}</div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                badgesContainer.appendChild(grid);
            }
        }

    } catch (err) {
        console.error('Could not load dashboard data', err);
    }
}

document.addEventListener('DOMContentLoaded', loadDashboard);
</script>

<style>
.activity-item { padding: 10px 12px; border-radius: 8px; background: #fff; margin-bottom: 10px; box-shadow: var(--shadow); }
.activity-row { display:flex; justify-content:space-between; font-weight:600; }
.activity-meta { color: #666; font-size:12px; margin-top:6px; }
.badges-grid { display:flex; gap:10px; flex-wrap:wrap; }
.badge-card { background:white; padding:10px 12px; border-radius:8px; display:flex; gap:10px; align-items:center; box-shadow:var(--shadow);} 
.badge-icon { font-size:22px; }
.badge-name { font-weight:700; }
.badge-desc { font-size:12px; color:#666; }
</style>

{% endblock %}